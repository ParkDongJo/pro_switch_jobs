
# Gitlab Ci

사내에서 사용하고 있는 Gitlab 의 ci 는 gitlab-ci.yml 을 통해서 정의된다. 우선 stages 에서 정의를 해줘야한다.
내부적으로 아래와 같은 jobs 실행을 하고 있는데, 여기서 sast 영역에서 오류가 났고 mr 의 파이프라인이 통과가 안되는 문제가 있었다.

```
stages:  
  - sastcheck_before  
  - sastcheck  
  - sastcheck_after  
  - test  
  - sonarqube-check  
  - cleanup_and_recreate
```

오류 메시지는 아래
![[Pasted image 20241014231828.png]]


```
Error resolving plugin [id: 'com.facebook.react.settings']

[56](https://gitlab.42dot.ai/vehicle-subscription/hyundai-selection-app/-/jobs/1695069#L56)> Included build '/builds/vehicle-subscription/hyundai-selection-app/node_modules/@react-native/gradle-plugin' does not exist.
```

이 부분을 중점적으로 보았는데, 실제로 ls -al 을 했을 시 node_modules 가 존재하지 않았다.
스크립트에서 아래와 같이 template 을 가져오는 부분이 있었고, 실제로 sast 를 진행하는 코드로 보였다.

```
- template: Security/SAST.gitlab-ci.yml
```

템플릿으로 제공되는 SAST.gitlab-ci.yml 코드인데
https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Jobs/SAST.gitlab-ci.yml\

문제가 되는 `spotbugs-sast` 단계는 결국 해당 템플릿 내에서 `- /analyzer run` 라는 명령을 통해서 최종 실행되고 있었다. 하지만 이 부분을 알게 되어도 실제로 손을 쓸수 있는 부분은 없어 보였다.

일단 저 템플릿은 RN 에 맞는 템플릿은 아니였다. 인프라 팀에서 안내해주는 템플릿으로 사용된것 같고 Android 만을 위한 템플릿으로 보였다.

sast 내부적으로도 RN을 위한 템플릿 제공은 없어보이기 때문에 실제로 script 를 작성해서 node_modules 부터 만드는 것이 맞아보였다.
하지만 RN의 빌드는 실제로 yarn 뿐만아니라 몇몇 cli 들이 동반되어야 하기 때문에 손쉬운 문제는 아니다.


막다른 길에서, 다시 뒤로 물러나서 '그러면 이전에는 어떻게 통과가 됐던거지?' 라는 의문으로 다시 시작했다.

기존 파이프라인들을 보니, 애초에도 sast 는 문제가 되고 있었다.
다만 이를 지나치고 mr 평가가 통과되었던 이유는 sast 와 이후 진행되는 jobs 인 test와 sonarcube 가 성공적으로 진행됐기 때문이였다.

다시 파이프라인을 살펴보니 새로 올린 mr 에는  test와 sonarcube jobs 들이 실행이 안되고 있었다.
그렇다면 gitlab-ci.yml 에서 무언가 잘못된거라고 봐야한다.

실제로 내가 다른 mr을 참고하여 실행의 조건에 아래와 같이 넣었었다.

```
script:  
  ...
rules:  
  - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ $PROTECTED_BRANCH_PATTERN

```

CI_MERGE_REQUEST_TARGET_BRANCH_NAME 같은 경우는 https://docs.gitlab.com/ee/ci/variables/predefined_variables.html 에서 확인 할 수 있듯이 gitlab CICD 에서 기본적으로 설정되어 있는 환경변수 들이다.

하지만 PROTECTED_BRANCH_PATTERN 는 찾을수가 없다. 이는 사용자가 직접 정의한거라고 봐야한다.

그런데 어디에도 정의되어 있지 않으니 빈값이였을 것이고, if 에 부합하지 않으니 실행조차 안되었던 거였다.

이 부분을 수정하려면 PROTECTED_BRANCH_PATTERN 아래의 두가지 방법중 하나로 정의해야한다


##### 1번째 방법
gitlab-ci.yml 파일에 아래와 같이 정의한다.

```
variables:
	PROTECTED_BRANCH_PATTERN: '/^main|release\/v.*$/'
```


##### 2번째 방법
gitlab 의 레포지토리에서 > settings > CI/CD > Variables 에 해당 변수를 정의하면 된다.