
모노레포 관리자 + 빌드시스템
pnpm + turbo
yarn-berry + lerna


# 빌드 시스템 역할
- 컴파일/ 트랜스파일링
- 코드 경량화(minify)
- 번들링
- 린팅 / 포멧팅 (eslint, prettire)
- 테스트

# 모노레포 매니저 역할
- 의존관리
- 빌드, 테스트 등등의 실행을 조율 + 병렬처리
- 코드 공유
- 린터, 포멧터, 테스트러너 등등을 통합하고 공유


# 모노레포 매니저 종류
자동차 + 운전자
빌드시스템 + 모노레포 매니저

- Nx
- Turborepo
- pnpm workspace
- yarn workspace


# 모노레포 과제

- 순환 종속성 : 하나의 모노레포 내에서 두 . 개이상의 프로젝트가 서로 의존하여 폐쇄 루프를 만들 때 발생
- 개발자 경험 : 느린빌드, 이해하기 어려운 오류, 복잡한 설정
- 레포 복잡성 : 규모와 복잡성이 증가함에 따라 의존성관리, 작업 오케스트레이션, 빌드성능 보장이 어려울 때
- 협업
- 

# 모노레포 작업
모노레포 관리자가 복잡한 워크플로를 오케스트레이션 하는 과정

- ==그래프 생성== : 프로젝트의 구성과 소스코드를 분석해서 필요한 작업 + 종속성을 파악하고 그래프를 구성 (의존성 유향 비순환 그래프 (DAG) + 작업그래프의 형태를 기반으로)
- ==위상정렬== : 작업 그래프에 위상정렬을 적용해서, 순서를 설정
- ==작업실행==: 정렬된 순서대로 작업을 실행
- ==캐싱== : 많은 모노레포 관리자는 반복작업을 피하려고 캐싱을 활용, 소스코드, 의존성이 변경되지 않은 경우 캐시를 재사용함

# 오케스트레이션을 위한 위상정렬

[위상정렬](https://www.google.com/search?q=%ED%81%B0%EB%8F%8C%EC%9D%98+%ED%84%B0%EC%A0%84+%EA%B0%9C%EB%B0%9C%EC%9E%90+%EC%9C%84%EC%83%81%EC%A0%95%EB%A0%AC&sca_esv=64d689169967df6d&rlz=1C5CHFA_enKR1105KR1106&ei=ykJWaZmrK7WQm9cPq-L4sAs&ved=0ahUKEwiZuKblh-qRAxU1yOYEHSsxHrYQ4dUDCBM&uact=5&oq=%ED%81%B0%EB%8F%8C%EC%9D%98+%ED%84%B0%EC%A0%84+%EA%B0%9C%EB%B0%9C%EC%9E%90+%EC%9C%84%EC%83%81%EC%A0%95%EB%A0%AC&gs_lp=Egxnd3Mtd2l6LXNlcnAiJ-2BsOuPjOydmCDthLDsoIQg6rCc67Cc7J6QIOychOyDgeygleugrEixVVC9AljKVHAIeAGQAQeYAYACoAGaVaoBBjUuMC40NrgBA8gBAPgBAZgCHKACqh6oAgXCAgoQABhHGNYEGLADwgIFEAAYgATCAhcQABiABBiKBRiRAhjnBhjqAhi0AtgBAcICFxAuGIAEGIoFGJECGOcGGOoCGLQC2AEBwgIFEC4YgATCAgsQLhiABBjHARivAcICBBAAGB7CAggQABiABBiiBMICBRAAGO8FwgIFECEYoAHCAgcQIRgKGKABwgIIEAAYiQUYogSYAwaIBgGQBgq6BgQIARgHkgcHMTIuMC4xNqAHidABsgcGNC4wLjE2uAeLHsIHBzEuMTYuMTHIB0WACAE&sclient=gws-wiz-serp#fpstate=ive&vld=cid:e0494245,vid:m-Z19d2uS0w,st:0)

**유효한 빌드 순서가 여러 개** 있을 수 있음.

모노레포에서 위상정렬은 아래와 같은 작업을 수행하기 위해 매우 중요

✔️ **빌드 순서**: 종속성에 따라 패키지를 빌드하거나 컴파일할 올바른 순서를 결정합니다.
✔️ **작업 실행**: 작업 간의 종속성을 고려하여 작업(예: 린팅, 테스트, 배포)을 스케줄링합니다.
✔️ **의존성 분석**: 순환 의존성(위상 정렬을 불가능하게 만드는)과 같은 잠재적인 문제를 식별합니다.
✔️ **캐싱**: 종속성이 변경될 때만 패키지가 다시 빌드되도록 하여 빌드 캐시를 최적화합니다

위상정렬이 가능하려면, ==그래프 내에 주기가 없다== 라는 것이 보장되어야한다.


# 위상정렬 전 순환검출
모노레포의 무결성을 검증하는데 중요한 단계
사이클 감지하고 불필요한 사이클을 제거한다.

✔️ **Nx**: `nx dep-graph` 명령은 종속성을 시각화하고 주기를 강조 표시할 수 있습니다.
✔️ **Turborepo**: Turborepo는 순환 종속성을 자동으로 감지하고 보고합니다.

# 그래프 도달 가능성 분석
도달 가능성 분석은 그래프의 맥락에서 특정 노드(예: 모노레포의 패키지)가 주어진 다른 노드에서 그래프의 가장자리를 통과하여 도달할 수 있는지를 결정하는 프로세스

✔️ **효율적인 리빌드**: 변경사항이 있으면 전체를 리빌드 하지 않고, 변경된 코드에 의존하는 특정 패키지를 정확히 찾아내어 타겟팅된 빠른 리빌드를 수행할 수 있습니다.
✔️ **타겟팅 테스트**: 마찬가지로 도달 가능성 분석은 패키지를 수정할 때 다시 실행해야 하는 테스트를 식별하는 데 도움이 됩니다.
✔️ **영향 평가**: 패키지를 크게 변경하기 전에 도달 가능성 분석을 통해 잠재적인 결과를 파악할 수 있습니다.


# 도달 가능성 분석을 위한 최단경로 알고리즘
모노레포 관리자가 작업 그래프 내에서 중요한 경로를 식별하여 빌드 프로세스를 최적화할 수 있도록 하는 최단 경로 알고리즘 ([다익스트라 알고리즘](https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm)과 [벨만-포드 알고리즘](https://en.wikipedia.org/wiki/Bellman%E2%80%93Ford_algorithm))

 [최단 경로 알고리즘은](https://en.wikipedia.org/wiki/Shortest_path_problem) 그래프에서 두 노드 사이의 가장 효율적인 경로를 찾는 데 사용

✔️ **빌드 시간 최소화**: 중요 경로(의존 작업의 가장 긴 체인)를 식별함으로써 모노레포 관리자는 해당 작업의 우선순위를 지정하고 독립 작업을 병렬화하여 전체 빌드 시간을 단축할 수 있습니다.
✔️ **리소스 최적화**: 최단 경로 알고리즘은 병목 현상을 파악하고 가장 필요한 곳에 컴퓨팅 성능을 집중하여 리소스를 효율적으로 할당할 수 있도록 도와줍니다.


# 캐싱
캐싱이 없으면 모노레포 빌드 속도가 매우 느려질 수 있다.

✔️ 캐싱은 계산 비용이 많이 드는 작업을 다시 실행할 필요성을 최소화하여 다른 프로세스를 위한 소중한 CPU 사이클과 메모리를 확보
✔️ 캐싱은 중복 작업을 방지하여 빌드 시간을 크게 단축

- Fire-based Caching
- Content-Addressable Stage(CAS)
- Distributed Caching


# 캐시 무효화
너무 강력한 캐시는 최신화된 빌드를 올리는데 방해가 될 수 있다. 적절한 상황에서는 캐시 무효화가 필요하다.

✔️ **잘못된 빌드**: 오래된 의존성 또는 코드 베이스의 변경으로 인해 빌드가 잘못된 결과를 생성할 수 있다
✔️ **예기치 않은 오류**: 오래된 캐시의 아티팩트로 인해 애플리케이션에서 예기치 않은 오류 및 불일치가 발생할 수 있다.\

- File-Based Invalidation
- Dependency-Based Invalidation
- Configuration-Based Invalidation
- Time-Based Invalidation


# 작업 스케쥴링
작업 스케줄링 전략의 선택은 모노레포의 규모와 복잡성, 사용할 수 있는 리소스, 프로젝트의 특정 요구사항 등 다양한 요인에 따라 달라진다.

✔️ **Nx**: 주로 병렬화 및 캐싱과 함께 위상 작업 스케줄링을 사용한다.

✔️ **Turborepo**: 병렬 작업 스케줄링과 캐싱을 중점적으로 강조합니다. 유향 그래프를 사용하여 작업 종속성을 모델링하고 그 관계에 따라 지능적으로 작업을 예약한다.

✔️ **Bazel**: 빌드 작업의 유향 그래프를 기반으로 정교한 작업 스케줄링 시스템을 사용한다.


# 모듈화 / 코드공유
잘 구조화된 모노레포는 모듈화와 효율적인 코드 공유의 토대 위에 구축



# 결론
모노레포 관리자를 선택하려면 몇 가지 주요 고려 사항


✔️ **그래프 유형**: 도구가 의존성 그래프, 작업 그래프 또는 둘 다 사용하는지 여부를 이해하는 것은 프로젝트 관계를 관리하고 빌드 프로세스를 조율하는 기능을 평가

✔️ **작업 스케줄링**: 스케줄링 방식(위상, 병렬, 증분 등)은 빌드 시간과 리소스 활용도에 직접적인 영향을 미치므로 모노레포의 성능을 최적화하는 데 중요한 고려 사항

✔️ **캐싱 메커니즘**: 특히 대규모 모노레포의 경우 빌드 속도를 높이려면 강력한 캐싱 전략이 필수 (파일 기반, 콘텐츠 주소 지정 가능, 분산)

✔️ **모듈화 및 코드 공유**: 도구가 모듈식 코드 구성 및 코드 공유 메커니즘을 지원하는지를 본다. 잘 정의된 모듈의 생성을 용이하게 하고 모노레포 내에서 코드 재사용이 용이한가를 평가

✔️ **추가 고려 사항**: 커뮤니티 지원, 문서화, 라이선스 비용, 기존 기술 스택 및 빌드 도구와의 통합


#### 참고자료
---
https://velog.io/@tap_kim/translate-monorepo-insights-nx-turborepo-and-pnpm
